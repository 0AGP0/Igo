// ===== FOLDER OPERATIONS =====
// Klas√∂r renk deƒüi≈ütirme, yeniden adlandƒ±rma, alt klas√∂r olu≈üturma

// Klas√∂r rengi deƒüi≈ütir
function changeFolderColor(folderId) {
  const folders = window.folders || [];
  const folder = folders.find(f => f.id === folderId);
  if (!folder) return;
  
  // Renk se√ßim modal'ƒ±nƒ± g√∂ster
  showColorPickerModal(folderId, folder.color);
}

// Renk se√ßici modal
function showColorPickerModal(folderId, currentColor) {
  const FOLDER_COLORS = window.FOLDER_COLORS || [];
  
  // Mevcut modal varsa kaldƒ±r
  const existingModal = document.getElementById('colorPickerModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  const modal = document.createElement('div');
  modal.id = 'colorPickerModal';
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal color-picker-modal" onclick="event.stopPropagation()">
      <div class="modal-title">üé® Klas√∂r Rengi Se√ß</div>
      <div class="color-picker-content">
        <div class="color-grid">
          ${FOLDER_COLORS.map(color => `
            <div class="color-option ${color === currentColor ? 'selected' : ''}" 
                 style="background: ${color};" 
                 data-color="${color}"
                 onclick="selectFolderColor('${folderId}', '${color}')">
              ${color === currentColor ? '‚úì' : ''}
            </div>
          `).join('')}
        </div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn secondary" onclick="closeColorPickerModal()">ƒ∞ptal</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Animasyon
  modal.style.display = 'flex';
  modal.style.opacity = '0';
  setTimeout(() => {
    modal.style.opacity = '1';
  }, 10);
  
  // Dƒ±≈üarƒ± tƒ±klanƒ±nca kapat
  modal.onclick = closeColorPickerModal;
}

function selectFolderColor(folderId, color) {
  const folders = window.folders || [];
  const STORAGE_KEYS = window.STORAGE_KEYS || {};
  
  const folder = folders.find(f => f.id === folderId);
  if (folder) {
    folder.color = color;
    
    // Anƒ±nda localStorage'a yaz
    try {
      localStorage.setItem(STORAGE_KEYS.FOLDERS, JSON.stringify(folders));
      console.log(`üé® Klas√∂r rengi deƒüi≈ütirildi ve kaydedildi: ${folder.name} ‚Üí ${color}`);
    } catch (error) {
      console.error('‚ùå Klas√∂r rengi kaydedilemedi:', error);
    }
    
    // Akƒ±llƒ± kaydetme - deƒüi≈üiklik olduƒüunda kaydet
    if (window.scheduleSave) window.scheduleSave();
    
    // Anƒ±nda UI g√ºncelle - gecikme yok!
    if (window.renderFolderList) window.renderFolderList();
    if (window.renderNotesImmediate) window.renderNotesImmediate(); // Debounce olmadan anƒ±nda render
    
    // Baƒülantƒ± √ßizgilerini de anƒ±nda g√ºncelle
    setTimeout(() => {
      if (window.drawConnections) window.drawConnections();
    }, 50); // √áok kƒ±sa gecikme ile baƒülantƒ±larƒ± g√ºncelle
    
    closeColorPickerModal();
  }
}

function closeColorPickerModal() {
  const modal = document.getElementById('colorPickerModal');
  if (modal) {
    modal.style.opacity = '0';
    setTimeout(() => {
      modal.remove();
    }, 200);
  }
}

// Klas√∂r yeniden adlandƒ±rma
function renameFolder(folderId) {
  console.log('üîÑ Klas√∂r yeniden adlandƒ±rma ba≈ülatƒ±lƒ±yor:', folderId);
  
  const folders = window.folders || [];
  const notes = window.notes || [];
  const folder = folders.find(f => f.id === folderId);
  
  if (!folder) {
    console.log('‚ùå Klas√∂r bulunamadƒ±:', folderId);
    return;
  }
  
  console.log('üìù Mevcut klas√∂r adƒ±:', folder.name);
  
  // Modal input kullan
  if (window.showInputModal) {
    window.showInputModal(
      'Klas√∂r√º Yeniden Adlandƒ±r',
      'Yeni klas√∂r adƒ±nƒ± girin...',
      folder.name,
      (newName) => {
        if (!newName || newName.trim() === '' || newName === folder.name) {
          console.log('‚ùå Ge√ßersiz klas√∂r adƒ± veya iptal edildi');
          return;
        }
        
        const trimmedName = newName.trim();
        console.log('üìù Yeni klas√∂r adƒ±:', trimmedName);
        
        // Aynƒ± isimde klas√∂r var mƒ± kontrol et
        const existingFolder = folders.find(f => f.name === trimmedName && f.id !== folderId);
        if (existingFolder) {
          if (window.showNotification) window.showNotification('Bu isimde bir klas√∂r zaten mevcut!', 'error');
          console.log('‚ùå Aynƒ± isimde klas√∂r mevcut');
          return;
        }
        
        // IPC ile klas√∂r√º yeniden adlandƒ±r
        if (typeof require !== 'undefined') {
          const { ipcRenderer } = require('electron');
          console.log('üì§ IPC mesajƒ± g√∂nderiliyor: rename-folder');
          
          // Alt klas√∂r i√ßin parentPath bilgisini ekle
          const folderData = {
            oldName: folder.name,
            newName: trimmedName
          };
          
          // Eƒüer alt klas√∂rse parentPath'i ekle
          if (folder.parentPath && folder.parentPath !== null) {
            folderData.parentPath = folder.parentPath;
            console.log('üìÅ Alt klas√∂r yeniden adlandƒ±rƒ±lƒ±yor, parentPath:', folder.parentPath);
          } else {
            console.log('üìÅ Ana klas√∂r yeniden adlandƒ±rƒ±lƒ±yor');
          }
          
          ipcRenderer.send('rename-folder', folderData);
          
          // Ba≈üarƒ±lƒ± olursa UI'yi g√ºncelle
          ipcRenderer.once('folder-renamed', (event, result) => {
            console.log('üì• IPC yanƒ±tƒ± alƒ±ndƒ±:', result);
            if (result.success) {
              // Eski klas√∂r adƒ±nƒ± sakla (alt klas√∂rleri bulmak i√ßin)
              const oldFolderName = folder.name;
              
              // Klas√∂rdeki notlarƒ±n klas√∂r ID'sini ve relativePath'ini g√ºncelle
              const newFolderId = trimmedName.toLowerCase().replace(/[^a-zA-Z0-9]/g, '');
              notes.forEach(note => {
                if (note.folderId === folder.id) {
                  note.folderId = newFolderId;
                  
                  // relativePath'i g√ºncelle (eƒüer varsa)
                  if (note.relativePath) {
                    const pathParts = note.relativePath.split('/');
                    if (pathParts.length > 1) {
                      // Alt klas√∂rdeki notlar i√ßin
                      pathParts[0] = trimmedName;
                      note.relativePath = pathParts.join('/');
                    } else {
                      // Ana klas√∂rdeki notlar i√ßin
                      note.relativePath = `${trimmedName}/${note.fileName}`;
                    }
                  }
                  
                  console.log('üìù Not g√ºncellendi:', note.title, '‚Üí relativePath:', note.relativePath);
                }
              });
              
              // Alt klas√∂rlerin parentPath'ini g√ºncelle (ana klas√∂r yeniden adlandƒ±rƒ±ldƒ±ƒüƒ±nda)
              if (!folder.parentPath) { // Ana klas√∂r ise
                // Eski klas√∂r adƒ±nƒ± kullanarak alt klas√∂rleri bul
                const updatedFolders = folders.filter(f => f.parentPath === oldFolderName);
                console.log('üìÅ Alt klas√∂rler bulundu:', updatedFolders.map(f => f.name));
                
                updatedFolders.forEach(subFolder => {
                  subFolder.parentPath = trimmedName;
                  // Alt klas√∂r√ºn path'ini de g√ºncelle
                  subFolder.path = `${trimmedName}/${subFolder.name}`;
                  // Alt klas√∂r√ºn parentId'sini yeni klas√∂r ID'si ile g√ºncelle
                  subFolder.parentId = newFolderId;
                  console.log('üìÅ Alt klas√∂r parentPath g√ºncellendi:', subFolder.name, '‚Üí', trimmedName);
                  console.log('üìÅ Alt klas√∂r path g√ºncellendi:', subFolder.path);
                  console.log('üìÅ Alt klas√∂r parentId g√ºncellendi:', subFolder.parentId);
                });
              }
              
              // Klas√∂r adƒ±nƒ± ve ID'sini g√ºncelle
              folder.name = trimmedName;
              folder.id = newFolderId;
              
              // UI'yi yenile
              if (window.renderFolderList) window.renderFolderList();
              if (window.renderNotes) window.renderNotes();
              if (window.saveFolders) window.saveFolders();
              
              // Baƒülantƒ± √ßizgilerini g√ºncelle
              setTimeout(() => {
                if (window.drawConnections) window.drawConnections();
              }, 100);
              
              console.log('‚úÖ Klas√∂r yeniden adlandƒ±rƒ±ldƒ±:', trimmedName);
            } else {
              if (window.showNotification) window.showNotification('Klas√∂r yeniden adlandƒ±rƒ±lamadƒ±: ' + result.error, 'error');
              console.log('‚ùå Klas√∂r yeniden adlandƒ±rƒ±lamadƒ±:', result.error);
            }
          });
        }
      }
    );
  }
}

// Alt klas√∂r olu≈üturma
function createSubFolder(parentFolderId) {
  console.log('üìÅ Alt klas√∂r olu≈üturma ba≈ülatƒ±lƒ±yor:', parentFolderId);
  
  const folders = window.folders || [];
  const FOLDER_COLORS = window.FOLDER_COLORS || [];
  
  const parentFolder = folders.find(f => f.id === parentFolderId);
  if (!parentFolder) {
    console.log('‚ùå Ana klas√∂r bulunamadƒ±:', parentFolderId);
    return;
  }
  
  console.log('üìÅ Ana klas√∂r bulundu:', parentFolder.name);
  
  // Modal input kullan
  if (window.showInputModal) {
    window.showInputModal(
      'Alt Klas√∂r Olu≈ütur',
      `"${parentFolder.name}" klas√∂r√º i√ßinde alt klas√∂r adƒ±nƒ± girin...`,
      '',
      (subFolderName) => {
        if (!subFolderName || subFolderName.trim() === '') {
          console.log('‚ùå Ge√ßersiz alt klas√∂r adƒ± veya iptal edildi');
          return;
        }
        
        const trimmedName = subFolderName.trim();
        console.log('üìù Alt klas√∂r adƒ±:', trimmedName);
        
        // Aynƒ± isimde alt klas√∂r var mƒ± kontrol et
        const existingSubFolder = folders.find(f => 
          f.name === trimmedName && 
          f.parentPath === parentFolder.path
        );
        if (existingSubFolder) {
          if (window.showNotification) window.showNotification('Bu isimde bir alt klas√∂r zaten mevcut!', 'error');
          console.log('‚ùå Aynƒ± isimde alt klas√∂r mevcut');
          return;
        }
        
        // IPC ile alt klas√∂r olu≈ütur
        if (typeof require !== 'undefined') {
          const { ipcRenderer } = require('electron');
          console.log('üì§ IPC mesajƒ± g√∂nderiliyor: create-folder');
          ipcRenderer.send('create-folder', {
            name: trimmedName,
            parentPath: parentFolder.path || parentFolder.name
          });
          
          // Ba≈üarƒ±lƒ± olursa UI'yi g√ºncelle
          ipcRenderer.once('folder-created', (event, result) => {
            console.log('üì• IPC yanƒ±tƒ± alƒ±ndƒ±:', result);
            if (result.success) {
              try {
                // Yeni alt klas√∂r√º ekle
                const newSubFolder = {
                  id: window.generateUniqueId(trimmedName, 'folder'), // Benzersiz ID
                  name: trimmedName,
                  color: FOLDER_COLORS[Math.floor(Math.random() * FOLDER_COLORS.length)],
                  path: parentFolder.path ? `${parentFolder.path}/${trimmedName}` : trimmedName,
                  parentId: parentFolderId,
                  level: (parentFolder.level || 0) + 1
                };
                
                window.folders.push(newSubFolder);
              } catch (error) {
                // Hata mesajƒ±nƒ± g√∂ster
                if (window.showNotification) window.showNotification(error.message, 'error');
                console.log('‚ùå Alt klas√∂r olu≈üturulamadƒ±:', error.message);
                return;
              }
              
              // UI'yi yenile
              if (window.renderFolderList) window.renderFolderList();
              if (window.renderNotesImmediate) window.renderNotesImmediate(); // Board √ºzerindeki klas√∂rleri anƒ±nda g√ºncelle
              if (window.saveFolders) window.saveFolders(); // Klas√∂rleri kaydet
              
              console.log('‚úÖ Alt klas√∂r olu≈üturuldu:', trimmedName);
            } else {
              if (window.showNotification) window.showNotification('Alt klas√∂r olu≈üturulamadƒ±: ' + result.error, 'error');
              console.log('‚ùå Alt klas√∂r olu≈üturulamadƒ±:', result.error);
            }
          });
        }
      }
    );
  }
}

function selectFolderColor(folderId, color) {
  const folders = window.folders || [];
  const STORAGE_KEYS = window.STORAGE_KEYS || {};
  
  const folder = folders.find(f => f.id === folderId);
  if (folder) {
    folder.color = color;
    
    // Anƒ±nda localStorage'a yaz
    try {
      localStorage.setItem(STORAGE_KEYS.FOLDERS, JSON.stringify(folders));
      console.log(`üé® Klas√∂r rengi deƒüi≈ütirildi ve kaydedildi: ${folder.name} ‚Üí ${color}`);
    } catch (error) {
      console.error('‚ùå Klas√∂r rengi kaydedilemedi:', error);
    }
    
    // Akƒ±llƒ± kaydetme - deƒüi≈üiklik olduƒüunda kaydet
    if (window.scheduleSave) window.scheduleSave();
    
    // Anƒ±nda UI g√ºncelle - gecikme yok!
    if (window.renderFolderList) window.renderFolderList();
    if (window.renderNotesImmediate) window.renderNotesImmediate(); // Debounce olmadan anƒ±nda render
    
    // Baƒülantƒ± √ßizgilerini de anƒ±nda g√ºncelle
    setTimeout(() => {
      if (window.drawConnections) window.drawConnections();
    }, 50); // √áok kƒ±sa gecikme ile baƒülantƒ±larƒ± g√ºncelle
    
    closeColorPickerModal();
  }
}

function closeColorPickerModal() {
  const modal = document.getElementById('colorPickerModal');
  if (modal) {
    modal.style.opacity = '0';
    setTimeout(() => {
      modal.remove();
    }, 200);
  }
}

// Notu ba≈üka klas√∂re ta≈üƒ±
function changeNoteFolder(noteId, newFolderId, folderName = null) {
  const notes = window.notes || [];
  const folders = window.folders || [];
  const note = notes.find(n => n.id === noteId);
  
  if (note) {
    const oldFolderId = note.folderId;
    note.folderId = newFolderId;
    note.updatedAt = new Date().toISOString();
    
    // Dosya sisteminde notu ta≈üƒ±
    if (typeof require !== 'undefined') {
      const { ipcRenderer } = require('electron');
      const folder = folders.find(f => f.id === newFolderId);
      
      ipcRenderer.send('move-note-to-folder', {
        noteId: noteId,
        folderId: newFolderId,
        folderName: folderName || (folder ? folder.name : null)
      });
      
      ipcRenderer.once('note-moved', (event, result) => {
        if (result.success) {
          console.log('üìÅ Not klas√∂re ta≈üƒ±ndƒ±:', note.title);
          
          // Not objesini g√ºncelle - yeni relative path ve fileName'i kaydet
          if (result.newRelativePath) {
            note.relativePath = result.newRelativePath;
            console.log('üìÅ Not relative path g√ºncellendi:', result.newRelativePath);
          }
          if (result.newFileName) {
            note.fileName = result.newFileName;
            console.log('üìÅ Not fileName g√ºncellendi:', result.newFileName);
          }
          
          // Ba≈üarƒ± bildirimi
          const targetFolder = folderName || (folder ? folder.name : 'Klas√∂rs√ºz Notlar');
          if (window.showNotification) {
            window.showNotification(`"${note.title}" ${targetFolder} klas√∂r√ºne ta≈üƒ±ndƒ±`, 'success');
          }
          
          // UI'yi g√ºncelle
          if (window.saveNotes) window.saveNotes();
          if (window.renderNotes) window.renderNotes();
          if (window.renderFolderList) window.renderFolderList();
        } else {
          console.error('‚ùå Not ta≈üƒ±namadƒ±:', result.error);
          
          // Hata bildirimi
          if (window.showNotification) {
            window.showNotification(`"${note.title}" ta≈üƒ±namadƒ±: ${result.error}`, 'error');
          }
          
          // Hata durumunda geri al
          note.folderId = oldFolderId;
          if (window.saveNotes) window.saveNotes();
          if (window.renderNotes) window.renderNotes();
          if (window.renderFolderList) window.renderFolderList();
        }
      });
    } else {
      // Electron yoksa sadece UI'yi g√ºncelle
      if (window.saveNotes) window.saveNotes();
      if (window.renderNotes) window.renderNotes();
      if (window.renderFolderList) window.renderFolderList();
    }
  }
}

// Klas√∂r silme modalƒ±nƒ± a√ß
function deleteFolder(folderId) {
  try {
    const folders = window.folders || [];
    const folder = folders.find(f => f.id === folderId);
    if (!folder) {
      console.error('‚ùå Silinecek klas√∂r bulunamadƒ±:', folderId);
      return;
    }
    
    // Diƒüer modal'larƒ± kapat
    const folderModal = document.getElementById('folderModal');
    if (folderModal) {
      folderModal.classList.remove('show');
    }
    
    // Modal'ƒ± a√ß
    const state = window.getState();
    state.folderToDelete = folderId;
    window.setState(state);
    
    const deleteModalOverlay = document.getElementById('deleteFolderModalOverlay');
    const deleteModalFolderTitle = document.getElementById('deleteModalFolderTitle');
    
    deleteModalFolderTitle.textContent = folder.name;
    deleteModalOverlay.classList.add('active');
  } catch (error) {
    console.error('‚ùå Klas√∂r silme hatasƒ±:', error);
    if (window.showNotification) {
      window.showNotification(`Klas√∂r silinirken hata olu≈ütu: ${error.message}`, 'error');
    }
  }
}

// Global exports
window.changeFolderColor = changeFolderColor;
window.renameFolder = renameFolder;
window.createSubFolder = createSubFolder;
window.showColorPickerModal = showColorPickerModal;
window.selectFolderColor = selectFolderColor;
window.closeColorPickerModal = closeColorPickerModal;
window.changeNoteFolder = changeNoteFolder;
window.deleteFolder = deleteFolder;

console.log('üé® Folder Operations y√ºklendi');

