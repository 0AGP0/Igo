// ===== NOTE MANAGER =====
// Not CRUD i≈ülemleri

function createNote(folderId = null) {
  // Popup'ƒ± gizle - yeni not olu≈üturulurken
  if (window.hideTitlePopup) window.hideTitlePopup();
  
  // Sadece not panelini a√ß, not olu≈üturma i≈ülemi kaydetme sƒ±rasƒ±nda yapƒ±lacak
  // Yeni not i√ßin null ge√ß ki eski i√ßerik gelmesin
  if (window.openNotePanel) window.openNotePanel(null);
}

// Belirli bir klas√∂rde not olu≈ütur
function createNoteInFolder(folderId) {
  // Popup'ƒ± gizle - yeni not olu≈üturulurken
  if (window.hideTitlePopup) window.hideTitlePopup();
  
  // Context menu'yu gizle
  if (window.hideContextMenu) window.hideContextMenu();
  
  const folders = window.folders || [];
  const folder = folders.find(f => f.id === folderId);
  if (!folder) {
    console.log('‚ùå Klas√∂r bulunamadƒ±:', folderId);
    return;
  }
  
  console.log('üìù Klas√∂rde not olu≈üturuluyor:', folder.name);
  
  // Not panelini a√ß ve klas√∂r ID'sini kaydet
  window.pendingNoteFolderId = folderId;
  if (window.openNotePanel) window.openNotePanel(null);
}

function updateNote(id, title, text) {
  const notes = window.notes || [];
  const note = notes.find(n => n.id === id);
  if (note) {
    const oldTitle = note.title;
    const oldText = note.text;
    const oldFileName = note.fileName;
    
    // Not verilerini g√ºncelle
    note.title = title;
    note.text = text;
    note.updatedAt = new Date().toISOString();
    note.tags = window.parseTags ? window.parseTags(text) : [];
    note.links = window.parseWikilinks ? window.parseWikilinks(text) : [];
    
    // Dosya adƒ± g√ºncelle (ba≈ülƒ±k deƒüi≈ütiyse)
    if (oldTitle !== title) {
      // Dosya adƒ± olu≈ütur - g√ºvenli karakterler kullan (bo≈üluklarƒ± koru)
      const safeTitle = title.replace(/[<>:"/\\|?*]/g, '').trim(); // Sadece ge√ßersiz karakterleri temizle, bo≈üluklarƒ± koru
      note.fileName = (safeTitle || 'Basliksiz Not') + (note.fileName?.endsWith('.md') || note.fileName?.endsWith('.txt') ? note.fileName.substring(note.fileName.lastIndexOf('.')) : '.md');
      console.log(`üìù Ba≈ülƒ±k deƒüi≈üti: "${oldTitle}" ‚Üí "${title}"`);
      console.log(`üìÅ Dosya adƒ± deƒüi≈üti: "${oldFileName}" ‚Üí "${note.fileName}"`);
    }
    
    // Not kartƒ±nƒ±n g√∂r√ºn√ºm√ºn√º g√ºncelle
    const noteElement = document.getElementById(`note-${id}`);
    if (noteElement) {
      // Ba≈ülƒ±ƒüƒ± g√ºncelle - sadece bu not kartƒ±ndaki title'ƒ± g√ºncelle
      const titleElement = noteElement.querySelector('.head .title');
      if (titleElement) {
        const oldTitle = titleElement.textContent;
        titleElement.textContent = title;
        console.log(`‚úÖ Not ba≈ülƒ±ƒüƒ± g√ºncellendi: ${id}`);
        console.log(`   Eski ba≈ülƒ±k: "${oldTitle}"`);
        console.log(`   Yeni ba≈ülƒ±k: "${title}"`);
        console.log(`   Element ID: ${noteElement.id}`);
      } else {
        console.error(`‚ùå Title elementi bulunamadƒ±: ${id}`);
        console.error(`   Note element:`, noteElement);
        console.error(`   Note element HTML:`, noteElement.innerHTML.substring(0, 200));
      }
      
      // ƒ∞√ßeriƒüi g√ºncelle
      const snippetElement = noteElement.querySelector('.snippet');
      if (snippetElement) {
        const renderedContent = window.renderMarkdown ? window.renderMarkdown(text) : text;
        snippetElement.innerHTML = renderedContent;
      }
      
      // Etiketleri g√ºncelle
      const tagsElement = noteElement.querySelector('.tags');
      if (tagsElement) {
        const updatedTags = window.parseTags ? window.parseTags(text) : [];
        tagsElement.innerHTML = updatedTags.slice(0, 4).map(tag => `<span class="tagtok">#${tag}</span>`).join('');
      }
    }
    
    // Dinamik g√ºncellemeler
    if (window.renderTags) window.renderTags(); // Etiketler panelini g√ºncelle
    if (window.renderGraph) window.renderGraph();
    setTimeout(() => {
      if (window.drawConnections) window.drawConnections(); // Baƒülantƒ± √ßizgilerini yeniden √ßiz
    }, 100);
    
    // Dosyayƒ± kaydet (ba≈ülƒ±k veya i√ßerik deƒüi≈ütiyse)
    if (oldTitle !== title || oldText !== text) {
      console.log('üìù Not deƒüi≈üti, dosyayƒ± kaydediliyor...');
      if (window.saveNoteToFile) window.saveNoteToFile(note);
    }
    
    // window.notes'u g√ºncelle
    window.notes = notes;
    
    // G√ºncellenmi≈ü not objesini d√∂nd√ºr
    return note;
  }
  return null;
}

function deleteNote(id) {
  const notes = window.notes || [];
  const note = notes.find(n => n.id === id);
  if (!note) return;
  
  // Modal'ƒ± a√ß
  const state = window.getState();
  state.noteToDelete = id;
  window.setState(state);
  
  const deleteModalOverlay = document.getElementById('deleteModalOverlay');
  const deleteModalNoteTitle = document.getElementById('deleteModalNoteTitle');
  
  deleteModalNoteTitle.textContent = note.title || 'Ba≈ülƒ±ksƒ±z Not';
  deleteModalOverlay.classList.add('active');
}

function selectNote(id) {
  // Yeni utility fonksiyonunu kullan
  if (window.SelectionManager) {
    window.SelectionManager.selectItem('note', id);
  }
  
  if (window.renderNotes) window.renderNotes();
  if (window.renderGraph) window.renderGraph();
  if (window.renderNoteList) window.renderNoteList();
  if (window.renderFolderList) window.renderFolderList();
  
  if (id) {
    const notes = window.notes || [];
    const note = notes.find(n => n.id === id);
    if (note) {
      const titleInput = document.getElementById('titleIn');
      const bodyInput = document.getElementById('bodyIn');
      
      if (titleInput) {
        titleInput.value = note.title;
      }
      
      if (bodyInput) {
        bodyInput.value = note.text;
      }
      
      if (window.renderPreview) window.renderPreview();
    }
  }
}

// Not d√ºzenleme fonksiyonu
function editNote(noteId) {
  // Popup'ƒ± gizle - not d√ºzenleme ba≈ülarken
  if (window.hideTitlePopup) window.hideTitlePopup();
  
  selectNote(noteId);
  if (window.openNotePanel) window.openNotePanel(noteId); // Doƒürudan noteId'yi ge√ß
}

// Delete modal fonksiyonlarƒ±
function closeDeleteModal() {
  const deleteModalOverlay = document.getElementById('deleteModalOverlay');
  deleteModalOverlay.classList.remove('active');
  const state = window.getState();
  state.noteToDelete = null;
  window.setState(state);
}

function confirmDeleteNote() {
  const state = window.getState();
  const noteToDelete = state.noteToDelete;
  
  if (noteToDelete) {
    const notes = window.notes || [];
    // Silinecek notu bul
    const noteToDeleteObj = notes.find(n => n.id === noteToDelete);
    
    // Notun i√ßeriƒüindeki media dosyalarƒ±nƒ± sil
    if (noteToDeleteObj) {
      deleteNoteMediaFiles(noteToDeleteObj);
      // Dosyayƒ± da sil
      deleteNoteFile(noteToDeleteObj);
    }
    
    // Ger√ßek silme i≈ülemi - REFERANSI KORUYARAK!
    const deleteIndex = window.notes.findIndex(n => n.id === noteToDelete);
    if (deleteIndex !== -1) {
      window.notes.splice(deleteIndex, 1);  // ‚úÖ Aynƒ± array'den sil
      console.log(`üóëÔ∏è Not silindi: ${noteToDeleteObj.title} (index: ${deleteIndex})`);
    }
    if (window.saveNotes) window.saveNotes();
    
    // LocalStorage'dan da sil
    const STORAGE_KEYS = window.STORAGE_KEYS || {};
    if (STORAGE_KEYS.NOTES) {
      localStorage.setItem(STORAGE_KEYS.NOTES, JSON.stringify(window.notes));
    }
    
    if (state.selectedNote === noteToDelete) {
      state.selectedNote = null;
    }
    
    // Multi-selection'dan da kaldƒ±r
    state.selectedNotes = (state.selectedNotes || []).filter(id => id !== noteToDelete);
    window.setState(state);
    
    if (window.renderNotes) window.renderNotes();
    if (window.renderTags) window.renderTags();
    if (window.renderGraph) window.renderGraph();
    
    // Modal'ƒ± kapat
    closeDeleteModal();
  }
}

// Notun i√ßeriƒüindeki media dosyalarƒ±nƒ± sil
function deleteNoteMediaFiles(note) {
  if (typeof require === 'undefined') return;
  
  const { ipcRenderer } = require('electron');
  const content = note.text || note.markdownContent || '';
  
  // Dosya referanslarƒ±nƒ± √ßƒ±karan fonksiyon (saveCurrentNoteContent'ten aynƒ±)
  const extractFilePaths = (text) => {
    const paths = new Set();
    
    // Markdown image: ![alt](path)
    const imageRegex = /!\[([^\]]*)\]\(([^)]+)\)/g;
    let match;
    while ((match = imageRegex.exec(text)) !== null) {
      let path = match[2];
      // file:// URL'sini temizle
      if (path.startsWith('file:///')) {
        path = path.replace(/^file:\/\/\//, '');
      }
      // .media klas√∂r√ºnden olan dosyalarƒ± al
      if (path && (path.includes('.media') || path.startsWith('.media'))) {
        paths.add(path);
      }
    }
    
    // HTML img tag: <img src="path">
    const imgTagRegex = /<img[^>]+src=["']([^"']+)["'][^>]*>/gi;
    while ((match = imgTagRegex.exec(text)) !== null) {
      let path = match[1];
      if (path.startsWith('file:///')) {
        path = path.replace(/^file:\/\/\//, '');
      }
      // .media klas√∂r√ºnden olan dosyalarƒ± al
      if (path && (path.includes('.media') || path.startsWith('.media'))) {
        paths.add(path);
      }
    }
    
    // HTML audio tag: <audio><source src="path">
    const audioRegex = /<audio[^>]*>[\s\S]*?<source[^>]+src=["']([^"']+)["'][^>]*>/gi;
    while ((match = audioRegex.exec(text)) !== null) {
      let path = match[1];
      if (path.startsWith('file:///')) {
        path = path.replace(/^file:\/\/\//, '');
      }
      // .media klas√∂r√ºnden olan dosyalarƒ± al
      if (path && (path.includes('.media') || path.startsWith('.media'))) {
        paths.add(path);
      }
    }
    
    return paths;
  };
  
  const filePaths = extractFilePaths(content);
  
  // Her dosyayƒ± sil
  filePaths.forEach(async (filePath) => {
    try {
      await ipcRenderer.invoke('delete-media-file', { filePath: filePath });
      console.log('‚úÖ Media dosyasƒ± silindi:', filePath);
    } catch (error) {
      console.error('‚ùå Media dosyasƒ± silinemedi:', filePath, error);
    }
  });
}

// Not dosyasƒ±nƒ± sil
function deleteNoteFile(note) {
  if (typeof require !== 'undefined') {
    const { ipcRenderer } = require('electron');
    ipcRenderer.send('delete-note-file', note);
  }
}

// Not detayƒ±nƒ± a√ß
function openNoteDetail(noteId) {
  // Popup'ƒ± gizle - not detayƒ± a√ßƒ±lƒ±rken
  if (window.hideTitlePopup) window.hideTitlePopup();
  
  selectNote(noteId);
  if (window.openNotePanel) window.openNotePanel(noteId); // Doƒürudan noteId'yi ge√ß
}

// Nota odaklan
function centerOnNote(noteId) {
  const notes = window.notes || [];
  // √ñnce note objesini bul
  const note = notes.find(n => n.id === noteId);
  if (!note || note.x === undefined || note.y === undefined) return;
  
  const boardwrap = document.querySelector('.boardwrap');
  if (!boardwrap) return;
  
  const boardwrapRect = boardwrap.getBoundingClientRect();
  
  // Note'un ger√ßek boyutlarƒ±nƒ± hesapla
  const noteWidth = note.customWidth || 280;
  const noteHeight = note.customHeight || (window.getNoteHeight ? window.getNoteHeight(note) : 200);
  
  // Notun merkez koordinatlarƒ± (stored x,y + half size)
  const noteCenterX = note.x + noteWidth / 2;
  const noteCenterY = note.y + noteHeight / 2;
  
  // Boardwrap'in merkez koordinatlarƒ±
  const viewportCenterX = boardwrapRect.width / 2;
  const viewportCenterY = boardwrapRect.height / 2;
  
  const boardZoom = window.boardZoom || 1;
  
  // Pan deƒüerlerini hesapla (notun merkezini viewport merkezine getir)
  const zoomVars = window.getZoomPanVars();
  zoomVars.boardPanX = viewportCenterX - (noteCenterX * boardZoom);
  zoomVars.boardPanY = viewportCenterY - (noteCenterY * boardZoom);
  window.setZoomPanVars(zoomVars);
  
  if (window.updateBoardTransform) window.updateBoardTransform();
}

// Not y√ºksekliƒüini hesapla
function getNoteHeight(note) {
  const contentLength = note.text.length;
  const titleLength = note.title.length;
  
  // Ba≈ülƒ±k uzunluƒüuna g√∂re minimum y√ºkseklik hesapla
  let minHeightForTitle = 160; // Base minimum
  if (titleLength > 20) {
    minHeightForTitle = 180; // Uzun ba≈ülƒ±k i√ßin
  }
  if (titleLength > 40) {
    minHeightForTitle = 200; // √áok uzun ba≈ülƒ±k i√ßin
  }
  
  // ƒ∞√ßerik uzunluƒüuna g√∂re y√ºkseklik - daha esnek hesaplama
  let noteHeight = minHeightForTitle;
  
  // ƒ∞√ßerik uzunluƒüuna g√∂re dinamik y√ºkseklik hesaplama
  if (contentLength > 100) {
    noteHeight = Math.max(noteHeight, 200);
  }
  if (contentLength > 300) {
    noteHeight = Math.max(noteHeight, 280);
  }
  if (contentLength > 600) {
    noteHeight = Math.max(noteHeight, 350);
  }
  if (contentLength > 1000) {
    noteHeight = Math.max(noteHeight, 450);
  }
  if (contentLength > 2000) {
    noteHeight = Math.max(noteHeight, 600);
  }
  
  return noteHeight;
}

// Not ID'sine g√∂re not bulma fonksiyonu
function getNoteById(noteId) {
  const notes = window.notes || [];
  return notes.find(note => note.id === noteId);
}

// Not i√ßeriƒüini g√ºncelle
function updateNoteContent(noteId, content) {
  if (noteId) {
    const notes = window.notes || [];
    const note = notes.find(n => n.id === noteId);
    if (note) {
      note.text = content;
      note.updatedAt = new Date().toISOString();
      note.tags = window.parseTags ? window.parseTags(content) : [];
      note.links = window.parseWikilinks ? window.parseWikilinks(content) : [];
      
      // Not kartƒ±nƒ±n g√∂r√ºn√ºm√ºn√º g√ºncelle
      const noteElement = document.getElementById(`note-${noteId}`);
      if (noteElement) {
        const snippetElement = noteElement.querySelector('.snippet');
        if (snippetElement) {
          const renderedContent = window.renderMarkdown ? window.renderMarkdown(content) : content;
          snippetElement.innerHTML = renderedContent;
        }
        
        // Etiketleri g√ºncelle
        const tagsElement = noteElement.querySelector('.tags');
        if (tagsElement) {
          tagsElement.innerHTML = note.tags.slice(0, 4).map(tag => `<span class="tagtok">#${tag}</span>`).join('');
        }
      }
      
      // Dinamik g√ºncellemeler
      if (window.renderTags) window.renderTags(); // Etiketler panelini g√ºncelle
      setTimeout(() => {
        if (window.drawConnections) window.drawConnections(); // Baƒülantƒ± √ßizgilerini yeniden √ßiz
      }, 100);
      
      console.log('üìù Not i√ßeriƒüi g√ºncellendi:', noteId);
      console.log('üè∑Ô∏è Etiketler:', note.tags);
      console.log('üîó Baƒülantƒ±lar:', note.links);
    }
  }
}

// Not ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
function updateNoteTitle(noteId, title) {
  try {
    if (noteId) {
      const notes = window.notes || [];
      const note = notes.find(n => n.id === noteId);
      if (note) {
        const oldTitle = note.title;
        note.title = title || 'Ba≈ülƒ±ksƒ±z Not';
        note.updatedAt = new Date().toISOString();
        
        // Not kartƒ±nƒ±n ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
        const noteElement = document.getElementById(`note-${noteId}`);
        if (noteElement) {
          const titleElement = noteElement.querySelector('.head .title');
          if (titleElement) {
            titleElement.textContent = note.title;
          }
        }
        
        // Dosya adƒ±nƒ± g√ºncelle (sadece ba≈ülƒ±k deƒüi≈ütiyse)
        if (oldTitle !== note.title && typeof window.updateNoteFileName === 'function') {
          try {
            window.updateNoteFileName(noteId, oldTitle, note.title);
          } catch (fileNameError) {
            console.error('‚ùå Dosya adƒ± g√ºncelleme hatasƒ±:', fileNameError);
          }
        }
        
        console.log('üìù Not ba≈ülƒ±ƒüƒ± g√ºncellendi:', noteId, title);
      }
    }
  } catch (error) {
    console.error('‚ùå Not ba≈ülƒ±ƒüƒ± g√ºncelleme hatasƒ±:', error);
  }
}

// Global exports
window.createNote = createNote;
window.createNoteInFolder = createNoteInFolder;
window.updateNote = updateNote;
window.deleteNote = deleteNote;
window.selectNote = selectNote;
window.editNote = editNote;
window.closeDeleteModal = closeDeleteModal;
window.confirmDeleteNote = confirmDeleteNote;
window.deleteNoteFile = deleteNoteFile;
window.openNoteDetail = openNoteDetail;
window.centerOnNote = centerOnNote;
window.getNoteHeight = getNoteHeight;
window.getNoteById = getNoteById;
window.updateNoteContent = updateNoteContent;
window.updateNoteTitle = updateNoteTitle;

console.log('üìù Note Manager y√ºklendi');

