// ===== DATA LOADING & SAVING SYSTEM =====

// LocalStorage i≈ülemleri
function saveNotes() {
  const DataManager = window.DataManager;
  const STORAGE_KEYS = window.STORAGE_KEYS;
  const notes = window.notes || [];
  
  if (DataManager && STORAGE_KEYS) {
    DataManager.save(STORAGE_KEYS.NOTES, notes);
  }
}

// Not pozisyonlarƒ±nƒ± kaydet
function saveNotePositions() {
  const STORAGE_KEYS = window.STORAGE_KEYS;
  const notes = window.notes || [];
  
  const positions = {};
  notes.forEach(note => {
    if (note.x !== undefined && note.y !== undefined) {
      positions[note.id] = {
        x: note.x,
        y: note.y,
        width: note.width || note.customWidth || 280,
        height: note.height || note.customHeight || 200
      };
    }
  });
  
  if (STORAGE_KEYS) {
    localStorage.setItem(STORAGE_KEYS.NOTE_POSITIONS, JSON.stringify(positions));
    console.log('üìç Not pozisyonlarƒ± kaydedildi:', Object.keys(positions).length, 'not');
  }
}

// T√ºm notlarƒ± dosyaya kaydet (sadece gerekli yerlerde √ßaƒürƒ±lacak)
function saveAllNotesToFiles() {
  const notes = window.notes || [];
  notes.forEach(note => {
    if (window.saveNoteToFile) window.saveNoteToFile(note);
  });
}

// Notu dosyaya kaydet (yeni sistem)
function saveNoteToFile(note) {
  if (typeof require !== 'undefined') {
    const { ipcRenderer } = require('electron');
    const generateFileName = window.generateFileName;
    
    // Dosya adƒ± ve eski dosya adƒ±nƒ± hesapla
    let fileName;
    let oldFileName;
    
    if (note.relativePath) {
      // Mevcut dosya varsa, relativePath'den eski dosya adƒ±nƒ± √ßƒ±kar
      oldFileName = note.relativePath.split('/').pop(); // path.basename yerine
      
      // Eƒüer note.fileName varsa onu kullan (yeniden olu≈üturma)
      if (note.fileName) {
        fileName = note.fileName;
        console.log('üìù Mevcut dosya adƒ± korunuyor:', fileName);
      } else {
        const extension = oldFileName.includes('.') ? oldFileName.split('.').pop() : 'md';
        fileName = generateFileName ? generateFileName(note.title, '.' + extension) : note.title + '.' + extension;
        console.log('üìù Dosya adƒ± ba≈ülƒ±ktan olu≈üturuluyor:', oldFileName, '‚Üí', fileName);
      }
    } else {
      // Yeni dosya i√ßin dosya adƒ± olu≈ütur
      const originalExtension = note.originalExtension || '.md';
      fileName = generateFileName ? generateFileName(note.title, originalExtension) : note.title + originalExtension;
      oldFileName = note.fileName;
      console.log('üÜï Yeni dosya olu≈üturuluyor:', fileName);
    }
    
    // Not objesine dosya adƒ±nƒ± ekle
    note.fileName = fileName;
    
    // IPC mesajƒ± g√∂nder
    ipcRenderer.send('save-note-to-file', {
      note: note,
      fileName: fileName,
      oldFileName: oldFileName
    });
    
    console.log('üíæ Not dosyaya kaydediliyor:', fileName);
  }
}

// Not dosya adƒ±nƒ± yeniden adlandƒ±r
function renameNoteFile(note, newTitle) {
  try {
    if (!note || !newTitle) return;
    
    const oldFileName = note.fileName;
    const extension = oldFileName.includes('.') ? oldFileName.split('.').pop() : 'md';
    
    // G√ºvenli dosya adƒ± olu≈ütur
    let newFileName;
    if (typeof window.generateFileName === 'function') {
      newFileName = window.generateFileName(newTitle, '.' + extension);
    } else {
      // Basit dosya adƒ± olu≈ütur
      newFileName = newTitle.replace(/[^a-zA-Z0-9ƒü√º≈üƒ±√∂√ßƒû√ú≈ûƒ∞√ñ√á\s]/g, '') + '.' + extension;
    }
    
    // Dosya adƒ± deƒüi≈ütiyse g√ºncelle
    if (oldFileName !== newFileName) {
      console.log('üìù Dosya yeniden adlandƒ±rƒ±lƒ±yor:', oldFileName, '‚Üí', newFileName);
      
      // Not nesnesindeki dosya adƒ±nƒ± g√ºncelle
      note.fileName = newFileName;
      
      // IPC mesajƒ± g√∂nder
      ipcRenderer.send('rename-note-file', {
        note: note,
        oldFileName: oldFileName,
        newFileName: newFileName
      });
      
      console.log('üíæ Dosya yeniden adlandƒ±rƒ±ldƒ± ve g√ºncellendi:', newFileName);
    }
  } catch (error) {
    console.error('‚ùå Dosya yeniden adlandƒ±rma hatasƒ±:', error);
  }
}

// Not dosya adƒ±nƒ± g√ºncelle
function updateNoteFileName(noteId, oldTitle, newTitle) {
  try {
    const notes = window.notes || [];
    const note = notes.find(n => n.id === noteId);
    
    if (note && note.fileName) {
      const oldFileName = note.fileName;
      const extension = oldFileName.includes('.') ? oldFileName.split('.').pop() : 'md';
      
      // G√ºvenli dosya adƒ± olu≈ütur
      let newFileName;
      if (typeof window.generateFileName === 'function') {
        newFileName = window.generateFileName(newTitle, '.' + extension);
      } else {
        // Basit dosya adƒ± olu≈ütur
        newFileName = newTitle.replace(/[^a-zA-Z0-9ƒü√º≈üƒ±√∂√ßƒû√ú≈ûƒ∞√ñ√á\s]/g, '') + '.' + extension;
      }
      
      // Dosya adƒ± deƒüi≈ütiyse g√ºncelle
      if (oldFileName !== newFileName) {
        console.log('üìù Dosya adƒ± deƒüi≈üikliƒüi tespit edildi:', oldFileName, '‚Üí', newFileName);
        
        // Not nesnesindeki dosya adƒ±nƒ± g√ºncelle
        note.fileName = newFileName;
        
        // IPC mesajƒ± g√∂nder - dosya adƒ±nƒ± g√ºncelle
        if (typeof require !== 'undefined') {
          try {
            const { ipcRenderer } = require('electron');
            
            // IPC response listener ekle
            const responseHandler = (event, response) => {
              try {
                if (response && response.success) {
                  console.log('‚úÖ Dosya yeniden adlandƒ±rƒ±ldƒ±:', response.oldFileName, '‚Üí', response.newFileName);
                  if (response.message) {
                    console.log('üìù Mesaj:', response.message);
                  }
                } else {
                  console.error('‚ùå Dosya yeniden adlandƒ±rma ba≈üarƒ±sƒ±z:', response ? response.error : 'Bilinmeyen hata');
                  // Hata durumunda eski dosya adƒ±nƒ± geri y√ºkle
                  note.fileName = oldFileName;
                }
              } catch (error) {
                console.error('‚ùå Response handler hatasƒ±:', error);
              } finally {
                // Listener'ƒ± temizle
                try {
                  ipcRenderer.removeListener('note-file-renamed', responseHandler);
                } catch (removeError) {
                  console.error('‚ùå Listener temizleme hatasƒ±:', removeError);
                }
              }
            };
            
            ipcRenderer.on('note-file-renamed', responseHandler);
            
            // IPC mesajƒ±nƒ± g√ºvenli ≈üekilde g√∂nder
            const ipcData = {
              noteId: noteId,
              oldFileName: oldFileName,
              newFileName: newFileName,
              note: note
            };
            
            // Data validasyonu
            if (!ipcData.oldFileName || !ipcData.newFileName) {
              console.error('‚ùå IPC data validasyon hatasƒ±:', ipcData);
              return;
            }
            
            ipcRenderer.send('rename-note-file', ipcData);
          } catch (ipcError) {
            console.error('‚ùå IPC g√∂nderme hatasƒ±:', ipcError);
            // IPC hatasƒ± durumunda eski dosya adƒ±nƒ± geri y√ºkle
            note.fileName = oldFileName;
          }
        }
        
        console.log('üìù Dosya adƒ± g√ºncelleme isteƒüi g√∂nderildi');
      } else {
        console.log('üìù Dosya adƒ± deƒüi≈ümedi, g√ºncelleme atlandƒ±');
      }
    } else {
      console.log('üìù Not veya dosya adƒ± bulunamadƒ±');
    }
  } catch (error) {
    console.error('‚ùå Dosya adƒ± g√ºncelleme hatasƒ±:', error);
  }
}

function loadNotes() {
  // Sadece dosyalardan notlarƒ± y√ºkle
  loadNotesFromFiles();
}

// Dosyalardan notlarƒ± y√ºkle
function loadNotesFromFiles() {
  if (typeof require !== 'undefined') {
    const { ipcRenderer } = require('electron');
    const STORAGE_KEYS = window.STORAGE_KEYS;
    const generateFileName = window.generateFileName;
    
    // IPC listener'ƒ± sadece bir kez ekle
    if (!window.notesFileListenerAdded) {
      ipcRenderer.on('notes-loaded-from-files', (event, result) => {
        if (result.success) {
          // Notlarƒ± sƒ±fƒ±rla - REFERANSI KORUYARAK!
          window.notes.length = 0;  // ‚úÖ Mevcut array'i temizle (yeni array olu≈üturma!)
          
          // localStorage'dan kaydedilmi≈ü pozisyonlarƒ± y√ºkle
          const savedPositions = JSON.parse(localStorage.getItem(STORAGE_KEYS.NOTE_POSITIONS) || '{}');
          console.log('üìç Kaydedilmi≈ü pozisyonlar y√ºklendi:', Object.keys(savedPositions).length, 'not');
          
          // Dosyadan y√ºklenen notlarƒ± ekle - DUPLƒ∞KASYON KONTROL√ú ƒ∞LE
          if (result.notes.length > 0) {
            result.notes.forEach(fileNote => {
              // DUPLƒ∞KASYON KONTROL√ú - Aynƒ± ID'li not zaten var mƒ±?
              const existingNoteIndex = window.notes.findIndex(n => n.id === fileNote.id);
              
              // Kaydedilmi≈ü pozisyon varsa kullan, yoksa rastgele olu≈ütur
              const savedPos = savedPositions[fileNote.id];
              let x, y;
              
              if (savedPos && savedPos.x !== undefined && savedPos.y !== undefined) {
                x = savedPos.x;
                y = savedPos.y;
                console.log(`üìç "${fileNote.title}" pozisyonu y√ºklendi: (${x}, ${y})`);
              } else {
                x = Math.random() * 400 + 100;
                y = Math.random() * 300 + 100;
                console.log(`üìç "${fileNote.title}" i√ßin yeni pozisyon olu≈üturuldu: (${x}, ${y})`);
              }
              
              if (existingNoteIndex !== -1) {
                // Not zaten var, g√ºncelle
                window.notes[existingNoteIndex] = {
                  ...fileNote,
                  x: x,
                  y: y,
                  width: savedPos?.width || 280,
                  height: savedPos?.height || 200,
                  folderId: fileNote.folderId || null,
                  tags: fileNote.tags || [],
                  links: fileNote.links || [],
                  isSaved: true,
                  fileName: fileNote.fileName || (generateFileName ? generateFileName(fileNote.title) : fileNote.title),
                  text: fileNote.text || fileNote.markdownContent || '',
                  markdownContent: fileNote.markdownContent || fileNote.text || ''
                };
                console.log(`‚úÖ "${fileNote.title}" g√ºncellendi (duplikasyon √∂nlendi)`);
              } else {
                // Not bulunamadƒ±, ekle
                window.notes.push({
                  ...fileNote,
                  x: x,
                  y: y,
                  width: savedPos?.width || 280,
                  height: savedPos?.height || 200,
                  folderId: fileNote.folderId || null,
                  tags: fileNote.tags || [],
                  links: fileNote.links || [],
                  isSaved: true,
                  fileName: fileNote.fileName || (generateFileName ? generateFileName(fileNote.title) : fileNote.title),
                  text: fileNote.text || fileNote.markdownContent || '',
                  markdownContent: fileNote.markdownContent || fileNote.text || ''
                });
                console.log(`üìù "${fileNote.title}" eklendi`);
              }
            });
          }
          
          // G√ºncellenmi≈ü notlarƒ± localStorage'a kaydet
          saveNotes();
          
          console.log(`üìö Toplam ${window.notes.length} not y√ºklendi (${result.notes.length} dosyadan)`);
          console.log('üîç window.notes g√ºncellendi:', window.notes.length, 'not');
        
          // Notlar y√ºklendikten sonra klas√∂rleri y√ºkle ve render et
          if (window.loadFolders) {
            window.loadFolders().then(() => {
              // Her durumda render et (dosya olsun ya da olmasƒ±n)
              if (window.renderNotes) window.renderNotes();
              if (window.renderTags) window.renderTags();
              if (window.renderGraph) window.renderGraph();
              
              // Senkronizasyon sonrasƒ± baƒülantƒ± √ßizgilerini √ßiz
              setTimeout(() => {
                if (window.drawConnections) window.drawConnections();
              }, 200);
            });
          }
        }
      });
      
      // Notes klas√∂r√ºndeki deƒüi≈üiklikleri dinle
      ipcRenderer.on('notes-folder-changed', (event, data) => {
        console.log('üìÅ Notes klas√∂r√ºnde deƒüi≈üiklik algƒ±landƒ±:', data);
        // Hem rename hem change event'lerini dinle
        if (data.eventType === 'rename' || data.eventType === 'change') {
          // Dosya deƒüi≈üti, silindi veya yeniden adlandƒ±rƒ±ldƒ±
          setTimeout(() => {
            syncNotesWithFiles();
          }, 500); // 500ms gecikme ile √ßoklu event'leri √∂nle
        }
      });
      
      // Ba≈ülangƒ±√ß tarama sonu√ßlarƒ±nƒ± dinle
      ipcRenderer.on('startup-scan-complete', (event, data) => {
        console.log('üìä Ba≈ülangƒ±√ß tarama tamamlandƒ±:', data);
        
        // Tarama sonu√ßlarƒ±nƒ± g√∂ster
        if (data.totalItems > 0) {
          console.log(`üìÅ ${data.folders.length} klas√∂r ve ${data.files.length} dosya bulundu`);
          
          // Eƒüer widget a√ßƒ±ksa bildirim g√∂ster
          if (document.getElementById('widget').classList.contains('open')) {
            if (window.showNotification) {
              window.showNotification(`üìÅ ${data.folders.length} klas√∂r ve ${data.files.length} dosya y√ºklendi`, 'success');
            }
          }
        } else {
          console.log('üìÅ Notes klas√∂r√º bo≈ü');
        }
        
        // Notlarƒ± dosyalardan y√ºkle
        loadNotesFromFiles();
        
        // Ba≈ülangƒ±√ß taramasƒ± sonrasƒ± baƒülantƒ± √ßizgilerini √ßiz - anƒ±nda
        if (window.drawConnections) window.drawConnections();
      });
      
      window.notesFileListenerAdded = true;
    }
    
    ipcRenderer.send('load-notes-from-files');
  }
}

// Notlarƒ± dosyalarla senkronize et (alias)
function syncNotesWithFiles() {
  console.log('üîÑ Notlar dosyalarla senkronize ediliyor...');
  loadNotesFromFiles();
}

// Klas√∂rleri localStorage'a kaydet - Debounce ile
let saveFoldersTimeout = null;
function saveFolders() {
  const DataManager = window.DataManager;
  const STORAGE_KEYS = window.STORAGE_KEYS;
  const folders = window.folders || [];
  
  // √ñnceki timeout'u iptal et
  if (saveFoldersTimeout) {
    clearTimeout(saveFoldersTimeout);
  }
  
  // 500ms sonra kaydet (debounce)
  saveFoldersTimeout = setTimeout(() => {
    if (DataManager && STORAGE_KEYS) {
      const success = DataManager.save(STORAGE_KEYS.FOLDERS, folders);
      if (success) {
        console.log('üìÅ Klas√∂rler kaydedildi:', folders.length, 'klas√∂r');
      } else {
        console.error('‚ùå Klas√∂rler kaydedilemedi');
      }
    }
    saveFoldersTimeout = null;
  }, 500);
}

// Klas√∂rleri dosya sisteminden y√ºkle - BASIT VERSƒ∞YON
function loadFolders() {
  console.log('üìÅ Klas√∂rler y√ºkleniyor...');
  
  return new Promise((resolve) => {
    if (typeof require !== 'undefined') {
      const { ipcRenderer } = require('electron');
      const DataManager = window.DataManager;
      const STORAGE_KEYS = window.STORAGE_KEYS;
      const FOLDER_COLORS = window.FOLDER_COLORS || [];
      
      // Notes klas√∂r√ºn√º tara ve klas√∂r yapƒ±sƒ±nƒ± al
      ipcRenderer.invoke('get-folder-structure').then(folderStructure => {
        console.log('üìÅ Klas√∂r yapƒ±sƒ± alƒ±ndƒ±:', folderStructure);
        
        // Kaydedilen klas√∂r verilerini y√ºkle
        const savedFolders = DataManager.load(STORAGE_KEYS.FOLDERS);
        console.log('üìÅ Kaydedilen klas√∂rler:', savedFolders);
        
        // Klas√∂rleri temizle - REFERANSI KORUYARAK!
        window.folders.length = 0;  // ‚úÖ Mevcut array'i temizle
        
        // Klas√∂r yapƒ±sƒ±nƒ± i≈üle
        function processFolders(folderData, parentId = null, level = 0) {
          folderData.forEach(item => {
            if (item.type === 'folder') {
              // Duplicate kontrol√º - aynƒ± ID'ye sahip klas√∂r zaten eklenmi≈ü mi?
              const existingFolder = window.folders.find(f => f.id === item.id && f.path === item.path);
              if (existingFolder) {
                console.log(`‚ö†Ô∏è Duplicate klas√∂r atlandƒ±: ${item.name} (ID: ${item.id}, Path: ${item.path})`);
                // Alt klas√∂rleri i≈üle (duplicate olsa bile)
                if (item.children && item.children.length > 0) {
                  processFolders(item.children, existingFolder.id, level + 1);
                }
                return; // Bu klas√∂r√º atla
              }
              
              // Kaydedilen klas√∂r verilerini bul (ID ve path'e g√∂re e≈üle≈ütir)
              // Eski format klas√∂r ID'leri i√ßin de uyumluluk ekle
              const savedFolder = savedFolders.find(f => {
                // ID e≈üle≈ümesi (normalize edilmi≈ü)
                const fIdNormalized = (f.id || '').toLowerCase().replace(/[^a-zA-Z0-9_]/g, '_');
                const itemIdNormalized = (item.id || '').toLowerCase().replace(/[^a-zA-Z0-9_]/g, '_');
                if (fIdNormalized === itemIdNormalized || f.id === item.id) return true;
                
                // Path ve name e≈üle≈ümesi
                if (f.path === item.path && f.name === item.name) return true;
                
                // Eski format: Klas√∂r adƒ± direkt ID olarak kullanƒ±lmƒ±≈ü olabilir
                if (f.id === item.name || f.id === item.name.toLowerCase()) return true;
                
                return false;
              });
              
              const folder = {
                id: item.id,
                name: item.name,
                color: savedFolder ? savedFolder.color : FOLDER_COLORS[window.folders.length % FOLDER_COLORS.length],
                parentId: parentId,
                parentPath: parentId ? window.folders.find(f => f.id === parentId)?.name : null,
                level: level,
                path: item.path,
                x: savedFolder ? savedFolder.x : undefined,
                y: savedFolder ? savedFolder.y : undefined,
                // Eski format uyumluluk: Klas√∂r adƒ±nƒ± da ID olarak sakla
                // Farklƒ± normalize formatlarƒ±nƒ± sakla (T√ºrk√ße karakter kaybƒ± durumu i√ßin)
                altIds: [
                  item.name.toLowerCase().replace(/[^a-z0-9_ƒü√º≈üi√∂√ßƒ±]/g, '_'), // T√ºrk√ße karakterler dahil
                  item.name.toLowerCase().replace(/[^a-z0-9_]/g, '_'), // ASCII (T√ºrk√ße karakter kaybƒ±)
                  item.name.toLowerCase(), // Lowercase
                  item.name, // Orijinal
                  item.name.replace(/[^a-zƒü√º≈üi√∂√ßƒ±]/g, ''), // Sadece harfler (T√ºrk√ße)
                  item.name.toLowerCase().replace(/[^a-z]/g, '') // Sadece harfler (ASCII)
                ]
              };
              window.folders.push(folder);
              
              // Alt klas√∂rleri i≈üle
              if (item.children && item.children.length > 0) {
                processFolders(item.children, item.id, level + 1);
              }
            }
          });
        }
        
        processFolders(folderStructure);
        
        console.log(`üìÅ Toplam ${window.folders.length} klas√∂r y√ºklendi`);
        if (window.renderFolderList) window.renderFolderList();
        resolve();
      }).catch(error => {
        console.error('‚ùå Klas√∂r yapƒ±sƒ± alƒ±namadƒ±:', error);
        window.folders.length = 0;  // ‚úÖ Referansƒ± koru
        if (window.renderFolderList) window.renderFolderList();
        resolve();
      });
    } else {
      window.folders.length = 0;  // ‚úÖ Referansƒ± koru
      if (window.renderFolderList) window.renderFolderList();
      resolve();
    }
  });
}

// Global exports
window.saveNotes = saveNotes;
window.saveNotePositions = saveNotePositions;
window.saveAllNotesToFiles = saveAllNotesToFiles;
window.saveNoteToFile = saveNoteToFile;
window.renameNoteFile = renameNoteFile;
window.updateNoteFileName = updateNoteFileName;
window.loadNotes = loadNotes;
window.loadNotesFromFiles = loadNotesFromFiles;
window.syncNotesWithFiles = syncNotesWithFiles;
window.saveFolders = saveFolders;
window.loadFolders = loadFolders;

console.log('üíæ Data Loader y√ºklendi');

